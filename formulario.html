<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <link
      rel="stylesheet"
      type="text/css"
      href="componentes.css"
      media="screen"
    />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Inscrição</title>
    <script
      src="https://unpkg.com/vanilla-masker@1.1.1/build/vanilla-masker.min.js"
      data-autoinit="true"
    ></script>
    <script src="cidades.js"></script>
  </head>
  <body>
    <header class="cabecalho">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        onclick="javascript:voltar()"
        width="34"
        height="34"
        viewBox="0 0 24 24"
        class="voltar"
      >
        <path d="M0 0h24v24H0z" fill="none" />
        <path
          d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"
          fill="white"
        />
      </svg>
      <i id="tituloEN">EM</i>
      <i id="tituloPOWER">POWER</i>
    </header>
    <div class="centrealizar">
      <div class="divTitulo">
        <h1 id="tituloDesafio"></h1>
      </div>
      <form class="centrealizar" id="myForm" onsubmit="javascript:enviar()">
        <br /><br />
        <p class="texto">Desafio</p>
        <input
          type="text"
          name="entry.1075876958"
          id="desafio"
          readonly="true"
          required
        />
        <p class="texto">Nome Completo:</p>
        <input id="nome" name="entry.1530501406" type="text" required />
        <p class="texto">Nome da Escola</p>
        <input id="escola" name="entry.2061797496" type="text" required />
        <p class="texto">Data de nascimento:</p>
        <input type="tel" id="nascimento" name="entry.83259554" required />

        <p class="texto">Estado:</p>
        <select id="estado" onchange="atualziarCidades()" name="entry.1500141418" required>
          <option selected disabled></option>
          <option value="MG">Minas Gerais</option>
          <option value="SP">São Paulo</option>
        </select>
        <p class="texto">Cidade:</p>
        <select id="cidade" name="entry.606213823" required>
          <option></option>
        </select>
        <p class="texto">Número de Telefone:</p>
        <input
          type="tel"
          id="telefone"
          name="entry.799252884"
          maxlength="15"
          required
        />
        <p class="texto">E-mail:</p>
        <input
          type="email"
          id="email"
          name="entry.1992091842"
          required
        />
        <br /><br /><br />
        <input type="submit" />
      </form>
    </div>
  </body>
  <script>
    window.onload = function() {
      var nome = document.location.search; // Pega o valor de search da url
      nome = nome.replace("?desafio=", ""); // Retira o "?desafio=" do valor de search
      const desafio = decodeURIComponent(nome); // Decodifica o valor
      document.getElementById("tituloDesafio").innerHTML = desafio;
      document.getElementById("desafio").value = desafio;
      VMasker(document.getElementById("telefone")).maskPattern(
        "(99) 99999-9999"
      );
      VMasker(document.getElementById("nascimento")).maskPattern("99/99/9999");
    };

    function atualziarCidades() {
      let cidades;
      const estado = document.getElementById("estado");
      const elCidade = document.getElementById("cidade");
      if (estado.value === "MG") {
        cidades = cidadesMG;
      } else {
        cidades = cidadesSP;
      }
      elCidade.innerHTML = "";
      cidades.forEach(c => {
        var option = document.createElement("option");
        option.text = c;
        option.value = c;
        elCidade.add(option);
      });
    }

    async function enviar() {
      const emailRegex = /^[a-zA-Z0-9.!#$%&’*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/;
      event.preventDefault();
      const url =
        "https://docs.google.com/forms/d/e/1FAIpQLSd_6dwknGdOU496pBnpstNvZOjK-WvJJb3vPcxRNzGDudnl7Q/formResponse";
      const myForm = document.getElementById("myForm");
      myForm.childNodes.forEach(i => {
        if (i.id === "telefone" && i.value.length !== 15) {
          throw alert("Número de celular inválido");
        } else if (i.id === "email" && !emailRegex.test(i.value)) {
          throw alert("email inválido");
        } else if (i.required && !Boolean(i.value)) {
          throw alert("Você precisa preencher todos os campos");
        }
      });
      const formData = new FormData(myForm);
      fetch(url, {method: "POST", body: formData, mode: "no-cors"})
      .catch(function (error){
          console.log(error);
          alert("Oops, algo deu errado ao submeter o desafio...")
          break
      })
      window.open("confirmacao.html", "_self")
    }
    function voltar() {
      window.open("index.html", "_self");
    }
  </script>
</html>
